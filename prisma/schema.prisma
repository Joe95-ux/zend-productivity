// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(auto()) @map("_id") @db.ObjectId
  clerkId       String         @unique
  email         String         @unique
  name          String?
  avatarUrl     String?
  boards        Board[]
  activities    Activity[]
  members       Member[]
  comments      Comment[]
  reactions     Reaction[]
  watches       Watch[]
  notifications Notification[]
  favorites     FavoriteBoard[]
  favoriteAttachments FavoriteAttachment[]
  organizationMemberships OrganizationMember[]
  joinRequests  BoardJoinRequest[]
  
  // Workspace relations
  workspaces           Workspace[]         // Personal workspaces owned by user
  workspaceMemberships WorkspaceMember[]    // Workspaces user is member of
  
  // Email preferences
  emailNotifications Boolean    @default(true)
  emailFrequency     String     @default("immediate") // "immediate", "daily", "weekly"
  notifyOwnActions   Boolean    @default(false) // Whether to receive notifications for own actions
  
  // ‚úÖ One-to-one relation (each user has at most one subscription)
  subscription  Subscription?  @relation(name: "UserSubscription")

  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
}

model Board {
  id          String     @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  ownerId     String     @db.ObjectId
  owner       User       @relation(fields: [ownerId], references: [id])
  
  // Board can belong to Workspace, Project, or Organization (for backward compatibility)
  workspaceId String?     @db.ObjectId
  workspace   Workspace?  @relation(fields: [workspaceId], references: [id])
  
  projectId   String?    @db.ObjectId
  project     Project?   @relation(fields: [projectId], references: [id])
  
  organizationId String?        @db.ObjectId
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  
  members     Member[]
  lists       List[]
  boardLabels BoardLabel[]
  activities  Activity[]
  watches     Watch[]
  favorites   FavoriteBoard[]
  joinRequests BoardJoinRequest[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
}

model Member {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  boardId   String   @db.ObjectId
  board     Board    @relation(fields: [boardId], references: [id])
  role      String   @default("member") // or "admin"
  createdAt DateTime @default(now())
}

model List {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String
  boardId   String   @db.ObjectId
  board     Board?   @relation(fields: [boardId], references: [id])
  position  Int
  cards     Card[]
  watches   Watch[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Card {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  listId      String      @db.ObjectId
  list        List?       @relation(fields: [listId], references: [id])
  position    Int
  isCompleted Boolean     @default(false)
  labels      Label[]
  checklists  Checklist[]
  attachments Attachment[]
  comments    Comment[]
  activities  Activity[]
  watches     Watch[]
  dueDate     DateTime?
  startDate   DateTime?
  isRecurring Boolean     @default(false)
  recurringType String?   // "daily", "weekly", "monthly", "yearly"
  reminderType String?    // "none", "at_due", "1_day", "2_days", "1_week"
  assignedTo  String?     // userId reference (optional)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model Label {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  color   String
  cardId  String  @db.ObjectId
  card    Card?   @relation(fields: [cardId], references: [id])
  // Optional link to a board template for easy matching
  boardLabelId String? @db.ObjectId
}

// Board-scoped reusable label templates
model BoardLabel {
  id      String  @id @default(auto()) @map("_id") @db.ObjectId
  name    String
  color   String
  boardId String  @db.ObjectId
  board   Board   @relation(fields: [boardId], references: [id])
}

model Checklist {
  id      String         @id @default(auto()) @map("_id") @db.ObjectId
  title   String
  items   ChecklistItem[]
  cardId  String         @db.ObjectId
  card    Card?          @relation(fields: [cardId], references: [id])
}

model ChecklistItem {
  id           String      @id @default(auto()) @map("_id") @db.ObjectId
  content      String
  isCompleted  Boolean     @default(false)
  position     Int         @default(0)
  checklistId  String      @db.ObjectId
  checklist    Checklist?  @relation(fields: [checklistId], references: [id])
}

model Attachment {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  url       String
  type      String?
  filename  String?
  cardId    String   @db.ObjectId
  card      Card?    @relation(fields: [cardId], references: [id])
  favorites FavoriteAttachment[]
  createdAt DateTime @default(now())
}

model Comment {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  content   String
  userId    String    @db.ObjectId
  user      User?     @relation(fields: [userId], references: [id])
  cardId    String    @db.ObjectId
  card      Card?     @relation(fields: [cardId], references: [id])
  reactions Reaction[]
  createdAt DateTime  @default(now())
}

model Reaction {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  emoji     String   // Unicode emoji character (e.g., "üëç", "‚ù§Ô∏è")
  commentId String   @db.ObjectId
  comment   Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String   @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  
  // Ensure one user can only react once per comment with the same emoji
  @@unique([commentId, userId, emoji])
  @@index([commentId])
  @@index([userId])
}

model Activity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  type      String   // "created_card", "moved_card", etc.
  message   String
  boardId   String   @db.ObjectId
  board     Board?   @relation(fields: [boardId], references: [id])
  cardId    String?  @db.ObjectId  // Optional card reference for card-specific activities
  card      Card?    @relation(fields: [cardId], references: [id])
  userId    String   @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Watch {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  
  // Polymorphic relations - only one will be set
  boardId   String?  @db.ObjectId
  board     Board?   @relation(fields: [boardId], references: [id])
  listId    String?  @db.ObjectId
  list      List?    @relation(fields: [listId], references: [id])
  cardId    String?  @db.ObjectId
  card      Card?    @relation(fields: [cardId], references: [id])
  
  createdAt DateTime @default(now())
  
  @@unique([userId, boardId, listId, cardId])
  @@index([userId])
  @@index([boardId])
  @@index([listId])
  @@index([cardId])
}

model Notification {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  type      String   // "card_comment", "card_moved", "board_activity", etc.
  title     String
  message   String
  isRead    Boolean  @default(false)
  
  // Optional references to the source of the notification
  boardId   String?  @db.ObjectId
  cardId    String?  @db.ObjectId
  activityId String? @db.ObjectId
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([userId, isRead])
  @@index([createdAt])
  @@index([boardId])
  @@index([cardId])
}

//
// üí≥ Billing Models
//
model Subscription {
  id                   String    @id @default(auto()) @map("_id") @db.ObjectId
  userId               String    @unique @db.ObjectId  // ‚úÖ must be unique for 1:1
  user                 User?     @relation(name: "UserSubscription", fields: [userId], references: [id])

  stripeCustomerId     String?
  stripeSubscriptionId String?
  plan                 Plan      @default(FREE)
  status               String    @default("active")
  currentPeriodEnd     DateTime?
  cancelAtPeriodEnd    Boolean   @default(false)

  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
}

enum Plan {
  FREE
  PRO
  TEAM
  ENTERPRISE
}

enum OrganizationRole {
  ADMIN
  MEMBER
  OBSERVER
}

model Organization {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  clerkOrgId  String   @unique // Clerk Organization ID
  name        String
  slug        String   @unique 
  // URL-friendly identifier
  status        String   @default("PENDING") // PENDING, ACTIVE, DELETED
  description String?
  logoUrl     String?
  boards      Board[]
  workspaces  Workspace[]  // Organization workspaces
  members     OrganizationMember[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model OrganizationMember {
  id             String           @id @default(auto()) @map("_id") @db.ObjectId
  organizationId String           @db.ObjectId
  organization   Organization      @relation(fields: [organizationId], references: [id])
  userId         String           @db.ObjectId
  user           User              @relation(fields: [userId], references: [id])
  role           OrganizationRole @default(MEMBER)
  invitedBy      String?          @db.ObjectId // User ID who sent the invitation
  invitedAt      DateTime?        // When invitation was sent
  joinedAt       DateTime?        // When user accepted invitation
  clerkOrgMemberId String?        @unique // Clerk Organization Membership ID
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  
  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
  @@index([role])
}

model FavoriteBoard {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  boardId   String   @db.ObjectId
  board     Board    @relation(fields: [boardId], references: [id])
  createdAt DateTime @default(now())
  
  @@unique([userId, boardId])
  @@index([userId])
  @@index([boardId])
}

model FavoriteAttachment {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  userId       String     @db.ObjectId
  user         User       @relation(fields: [userId], references: [id])
  attachmentId String     @db.ObjectId
  attachment   Attachment @relation(fields: [attachmentId], references: [id])
  createdAt    DateTime   @default(now())
  
  @@unique([userId, attachmentId])
  @@index([userId])
  @@index([attachmentId])
}

model BoardJoinRequest {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  boardId     String   @db.ObjectId
  board       Board    @relation(fields: [boardId], references: [id])
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  status      String   @default("pending") // "pending", "approved", "rejected"
  requestedAt DateTime @default(now())
  processedAt DateTime?
  processedBy String?  @db.ObjectId // User ID who approved/rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([boardId, userId])
  @@index([boardId])
  @@index([userId])
  @@index([status])
  @@index([boardId, status])
}

//
// üè¢ Workspace & Project Models
//
model Workspace {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  slug        String   // URL-friendly identifier
  color       String?  // Optional: workspace color for UI
  icon        String?  // Optional: workspace icon
  
  // Workspace can belong to User (personal) OR Organization (team)
  ownerId     String?  @db.ObjectId
  owner       User?    @relation(fields: [ownerId], references: [id])
  
  organizationId String?        @db.ObjectId
  organization   Organization?   @relation(fields: [organizationId], references: [id])
  
  // Workspace members (for personal workspaces, user can invite others)
  members     WorkspaceMember[]
  projects    Project[]
  boards      Board[]  // Boards can be directly under workspace (no project)
  
  status      String   @default("active") // "active", "archived"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([ownerId, slug])  // Unique slug per user
  @@unique([organizationId, slug])  // Unique slug per org
  @@index([ownerId])
  @@index([organizationId])
  @@index([status])
}

model WorkspaceMember {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  workspaceId String   @db.ObjectId
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  userId      String   @db.ObjectId
  user        User     @relation(fields: [userId], references: [id])
  role        String   @default("member") // "admin", "member", "viewer"
  createdAt   DateTime @default(now())
  
  @@unique([workspaceId, userId])
  @@index([workspaceId])
  @@index([userId])
}

model Project {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  workspaceId String   @db.ObjectId
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  boards      Board[]
  color       String?  // Optional: project color
  icon        String?  // Optional: project icon
  status      String   @default("active") // "active", "archived", "completed"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([workspaceId])
  @@index([workspaceId, status])
}
